{% extends "base.html" %}

{% block title %}{{ 'Modifica' if news else 'Nuova' }} News - Maqueta Web{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}" class="text-decoration-none">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('lista_news') }}" class="text-decoration-none">News</a></li>
                <li class="breadcrumb-item active">{{ 'Modifica' if news else 'Nuova' }}</li>
            </ol>
        </nav>
        <h1>
            <i class="bi bi-{{ 'pencil-square' if news else 'plus-circle' }}"></i>
            {{ 'Modifica News' if news else 'Nuova News' }}
        </h1>
    </div>
    <a href="{{ url_for('lista_news') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i>
        Torna alla lista
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <form method="POST" id="newsForm" enctype="multipart/form-data">
            <!-- Titolo e Slug -->
            <div class="card mb-4 slide-up">
                <div class="card-header">
                    <i class="bi bi-type me-2"></i>
                    Titolo e URL
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-12">
                            <label class="form-label">
                                Titolo <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control form-control-lg" name="titolo" id="titoloInput"
                                value="{{ news.titolo if news else '' }}"
                                placeholder="Inserisci il titolo della news" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Slug URL</label>
                            <div class="input-group">
                                <span class="input-group-text">/news/</span>
                                <input type="text" class="form-control" name="slug" id="slugInput"
                                    value="{{ news.slug if news else '' }}"
                                    placeholder="titolo-della-news">
                            </div>
                            <small class="text-muted">Lascia vuoto per generare automaticamente dal titolo</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenuto -->
            <div class="card mb-4 slide-up stagger-1">
                <div class="card-header">
                    <i class="bi bi-file-text me-2"></i>
                    Contenuto
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-12">
                            <label class="form-label">Estratto</label>
                            <textarea class="form-control" name="estratto" rows="3"
                                placeholder="Breve descrizione per anteprima (max 500 caratteri)"
                                maxlength="500">{{ news.estratto if news and news.estratto else '' }}</textarea>
                            <small class="text-muted">Questo testo viene mostrato nelle anteprime e nei risultati di ricerca</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Contenuto Completo</label>
                            <textarea class="form-control" name="contenuto" id="contenutoEditor" rows="15"
                                placeholder="Scrivi qui il contenuto completo della news...">{{ news.contenuto if news and news.contenuto else '' }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Immagine -->
            <div class="card mb-4 slide-up stagger-2">
                <div class="card-header">
                    <i class="bi bi-image me-2"></i>
                    Immagine di Copertina
                </div>
                <div class="card-body">
                    {% if news and news.immagine %}
                    <div class="mb-3 p-3 border rounded bg-light">
                        <div class="d-flex align-items-center">
                            <img src="{{ url_for('static', filename='uploads/' + news.immagine) }}"
                                 alt="Anteprima" class="rounded me-3"
                                 style="width: 120px; height: 80px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <strong class="d-block">Immagine attuale</strong>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" name="rimuovi_immagine" id="rimuovi_immagine">
                                    <label class="form-check-label text-danger" for="rimuovi_immagine">
                                        Rimuovi immagine
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <input type="file" class="form-control" name="immagine" id="immagineInput"
                        accept="image/png,image/jpeg,image/jpg,image/gif,image/webp">
                    <small class="text-muted">Formati: PNG, JPG, GIF, WebP (max 16MB). Dimensione consigliata: 1200x630px</small>

                    <!-- Anteprima immagine -->
                    <div class="mt-3" id="previewContainer" style="display: none;">
                        <div class="p-3 border rounded bg-light">
                            <label class="form-label small text-muted">Anteprima nuova immagine:</label>
                            <img id="imagePreview" src="" alt="Anteprima"
                                 class="img-fluid rounded" style="max-height: 200px;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categoria e Tags -->
            <div class="card mb-4 slide-up stagger-3">
                <div class="card-header">
                    <i class="bi bi-tags me-2"></i>
                    Categorizzazione
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-control" name="categoria"
                                value="{{ news.categoria if news and news.categoria else '' }}"
                                placeholder="Es. Aziendale, Prodotti, Eventi"
                                list="categorieList">
                            <datalist id="categorieList">
                                <option value="Aziendale">
                                <option value="Prodotti">
                                <option value="Eventi">
                                <option value="Comunicati">
                                <option value="Tutorial">
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tags</label>
                            <input type="text" class="form-control" name="tags"
                                value="{{ news.tags if news and news.tags else '' }}"
                                placeholder="tag1, tag2, tag3">
                            <small class="text-muted">Separa i tag con virgole</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pubblicazione -->
            <div class="card mb-4 slide-up stagger-4">
                <div class="card-header">
                    <i class="bi bi-calendar-check me-2"></i>
                    Pubblicazione
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label">Data e Ora Pubblicazione</label>
                            <input type="datetime-local" class="form-control" name="data_pubblicazione"
                                value="{{ news.data_pubblicazione.strftime('%Y-%m-%dT%H:%M') if news and news.data_pubblicazione else '' }}">
                            <small class="text-muted">Lascia vuoto per pubblicare immediatamente</small>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded h-100" style="background: var(--gray-100);">
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-3" type="checkbox" name="pubblicato" id="pubblicato"
                                        {{ 'checked' if news and news.pubblicato else '' }}
                                        style="width: 3.5rem; height: 1.75rem;">
                                    <label class="form-check-label" for="pubblicato">
                                        <strong class="d-block">Pubblicato</strong>
                                        <small class="text-muted">Visibile al pubblico</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded h-100" style="background: var(--gray-100);">
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-3" type="checkbox" name="in_evidenza" id="in_evidenza"
                                        {{ 'checked' if news and news.in_evidenza else '' }}
                                        style="width: 3.5rem; height: 1.75rem;">
                                    <label class="form-check-label" for="in_evidenza">
                                        <strong class="d-block">In Evidenza</strong>
                                        <small class="text-muted">Mostra in homepage</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pulsanti Azione -->
            <div class="d-flex gap-3 mb-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-lg me-1"></i>
                    {{ 'Salva Modifiche' if news else 'Pubblica News' }}
                </button>
                <a href="{{ url_for('lista_news') }}" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-lg me-1"></i>
                    Annulla
                </a>
            </div>
        </form>
    </div>

    <!-- Sidebar Info -->
    <div class="col-lg-4">
        {% if news %}
        <!-- Info News -->
        <div class="card mb-4 slide-up">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>
                Informazioni News
            </div>
            <div class="card-body">
                {% if news.immagine %}
                <img src="{{ url_for('static', filename='uploads/' + news.immagine) }}"
                     alt="{{ news.titolo }}" class="img-fluid rounded mb-3">
                {% endif %}

                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">ID News</span>
                    <span class="fw-semibold">#{{ news.id }}</span>
                </div>
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Creata il</span>
                    <span class="fw-semibold">{{ news.data_creazione.strftime('%d/%m/%Y %H:%M') if news.data_creazione else '-' }}</span>
                </div>
                {% if news.data_modifica %}
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Ultima modifica</span>
                    <span class="fw-semibold">{{ news.data_modifica.strftime('%d/%m/%Y %H:%M') }}</span>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Stato</span>
                    {% if news.pubblicato %}
                    <span class="badge bg-success">Pubblicato</span>
                    {% else %}
                    <span class="badge bg-secondary">Bozza</span>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Visualizzazioni</span>
                    <span class="fw-semibold">
                        <i class="bi bi-eye me-1"></i>{{ news.visualizzazioni }}
                    </span>
                </div>
                {% if news.autore_id %}
                {% set autore = news.get_autore() %}
                {% if autore %}
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Autore</span>
                    <span class="fw-semibold">{{ autore.nome_completo }}</span>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Azioni Rapide -->
        <div class="card slide-up stagger-1">
            <div class="card-header">
                <i class="bi bi-lightning-charge me-2"></i>
                Azioni Rapide
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="bi bi-trash me-2"></i>Elimina News
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Suggerimenti -->
        <div class="card slide-up">
            <div class="card-header">
                <i class="bi bi-lightbulb me-2"></i>
                Suggerimenti
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="d-flex mb-3">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>Scegli un titolo accattivante e descrittivo</span>
                    </li>
                    <li class="d-flex mb-3">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>L'estratto appare nelle anteprime - rendilo interessante</span>
                    </li>
                    <li class="d-flex mb-3">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>Usa un'immagine di copertina di alta qualita</span>
                    </li>
                    <li class="d-flex mb-3">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>Categorizza correttamente per una migliore organizzazione</span>
                    </li>
                    <li class="d-flex">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>Puoi programmare la pubblicazione per una data futura</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Shortcut -->
        <div class="card mt-4 slide-up stagger-1">
            <div class="card-header">
                <i class="bi bi-keyboard me-2"></i>
                Formattazione Testo
            </div>
            <div class="card-body">
                <p class="small text-muted mb-2">Puoi usare HTML nel contenuto:</p>
                <code class="d-block mb-1">&lt;b&gt;grassetto&lt;/b&gt;</code>
                <code class="d-block mb-1">&lt;i&gt;corsivo&lt;/i&gt;</code>
                <code class="d-block mb-1">&lt;a href="..."&gt;link&lt;/a&gt;</code>
                <code class="d-block mb-1">&lt;ul&gt;&lt;li&gt;lista&lt;/li&gt;&lt;/ul&gt;</code>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if news %}
<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    Conferma Eliminazione
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Sei sicuro di voler eliminare la news <strong>{{ news.titolo }}</strong>?</p>
                <p class="text-muted small mt-2 mb-0">Questa azione non puo essere annullata.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form action="{{ url_for('elimina_news', id=news.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Elimina
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Auto-genera slug dal titolo
    document.getElementById('titoloInput').addEventListener('input', function() {
        const slugInput = document.getElementById('slugInput');
        // Genera slug solo se l'utente non ha gia inserito uno slug personalizzato
        if (!slugInput.dataset.customized) {
            const slug = this.value
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Rimuove accenti
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            slugInput.value = slug;
        }
    });

    // Marca lo slug come personalizzato se l'utente lo modifica manualmente
    document.getElementById('slugInput').addEventListener('input', function() {
        this.dataset.customized = 'true';
    });

    // Image preview
    document.getElementById('immagineInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.style.display = 'none';
        }
    });

    // Form validation feedback
    document.getElementById('newsForm').addEventListener('submit', function(e) {
        const btn = this.querySelector('button[type="submit"]');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvataggio...';
        btn.disabled = true;
    });
</script>
{% endblock %}
