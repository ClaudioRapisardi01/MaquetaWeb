{% extends "base.html" %}

{% block title %}{{ 'Modifica' if news else 'Nuova' }} News - Maqueta Web{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}" class="text-decoration-none">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('lista_news') }}" class="text-decoration-none">News</a></li>
                <li class="breadcrumb-item active">{{ 'Modifica' if news else 'Nuova' }}</li>
            </ol>
        </nav>
        <h1>
            <i class="bi bi-{{ 'pencil-square' if news else 'plus-circle' }}"></i>
            {{ 'Modifica News' if news else 'Nuova News' }}
        </h1>
    </div>
    <a href="{{ url_for('lista_news') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i>
        Torna alla lista
    </a>
</div>

<div class="row">
    <div class="col-lg-8">
        <form method="POST" id="newsForm" enctype="multipart/form-data">
            <!-- Titolo e Slug -->
            <div class="card mb-4 slide-up">
                <div class="card-header">
                    <i class="bi bi-type me-2"></i>
                    Titolo e URL
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-12">
                            <label class="form-label">
                                Titolo <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control form-control-lg" name="titolo" id="titoloInput"
                                value="{{ news.titolo if news else '' }}"
                                placeholder="Inserisci il titolo della news" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Slug URL</label>
                            <div class="input-group">
                                <span class="input-group-text">/news/</span>
                                <input type="text" class="form-control" name="slug" id="slugInput"
                                    value="{{ news.slug if news else '' }}"
                                    placeholder="titolo-della-news">
                            </div>
                            <small class="text-muted">Lascia vuoto per generare automaticamente dal titolo</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contenuto -->
            <div class="card mb-4 slide-up stagger-1">
                <div class="card-header">
                    <i class="bi bi-file-text me-2"></i>
                    Contenuto
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-12">
                            <label class="form-label">Estratto</label>
                            <textarea class="form-control" name="estratto" rows="3"
                                placeholder="Breve descrizione per anteprima (max 500 caratteri)"
                                maxlength="500">{{ news.estratto if news and news.estratto else '' }}</textarea>
                            <small class="text-muted">Questo testo viene mostrato nelle anteprime e nei risultati di ricerca</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Contenuto Completo</label>
                            <!-- Toolbar di formattazione -->
                            <div class="editor-toolbar btn-toolbar mb-2 p-2 bg-light rounded border" role="toolbar">
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')" title="Grassetto">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')" title="Corsivo">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('underline')" title="Sottolineato">
                                        <i class="bi bi-type-underline"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('strikethrough')" title="Barrato">
                                        <i class="bi bi-type-strikethrough"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('h2')" title="Titolo H2">
                                        <i class="bi bi-type-h2"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('h3')" title="Titolo H3">
                                        <i class="bi bi-type-h3"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('ul')" title="Lista puntata">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('ol')" title="Lista numerata">
                                        <i class="bi bi-list-ol"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm me-2" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('link')" title="Inserisci Link">
                                        <i class="bi bi-link-45deg"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('image')" title="Inserisci Immagine">
                                        <i class="bi bi-image"></i>
                                    </button>
                                </div>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('quote')" title="Citazione">
                                        <i class="bi bi-blockquote-left"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('code')" title="Codice">
                                        <i class="bi bi-code"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="formatText('hr')" title="Linea orizzontale">
                                        <i class="bi bi-hr"></i>
                                    </button>
                                </div>
                            </div>
                            <textarea class="form-control" name="contenuto" id="contenutoEditor" rows="15"
                                placeholder="Scrivi qui il contenuto completo della news...">{{ news.contenuto if news and news.contenuto else '' }}</textarea>
                            <small class="text-muted">Usa la toolbar sopra per formattare il testo o inserisci direttamente codice HTML</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Immagine -->
            <div class="card mb-4 slide-up stagger-2">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>
                        <i class="bi bi-image me-2"></i>
                        Immagine di Copertina
                    </span>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#galleriaModal">
                        <i class="bi bi-images me-1"></i>Galleria Immagini
                    </button>
                </div>
                <div class="card-body">
                    {% if news and news.immagine %}
                    <div class="mb-3 p-3 border rounded bg-light">
                        <div class="d-flex align-items-center">
                            <img src="{{ url_for('static', filename='uploads/' + news.immagine) }}"
                                 alt="Anteprima" class="rounded me-3"
                                 style="width: 120px; height: 80px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <strong class="d-block">Immagine attuale</strong>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" name="rimuovi_immagine" id="rimuovi_immagine">
                                    <label class="form-check-label text-danger" for="rimuovi_immagine">
                                        Rimuovi immagine
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <input type="file" class="form-control" name="immagine" id="immagineInput"
                        accept="image/png,image/jpeg,image/jpg,image/gif,image/webp">
                    <small class="text-muted">Formati: PNG, JPG, GIF, WebP (max 16MB). Dimensione consigliata: 1200x630px</small>
                    <small class="d-block text-info mt-1"><i class="bi bi-info-circle me-1"></i>Oppure scegli un'immagine dalla Galleria</small>

                    <!-- Anteprima immagine -->
                    <div class="mt-3" id="previewContainer" style="display: none;">
                        <div class="p-3 border rounded bg-light">
                            <label class="form-label small text-muted">Anteprima nuova immagine:</label>
                            <img id="imagePreview" src="" alt="Anteprima"
                                 class="img-fluid rounded" style="max-height: 200px;">
                        </div>
                    </div>

                    <!-- Campo nascosto per immagine selezionata dalla galleria -->
                    <input type="hidden" name="immagine_esistente" id="immagineEsistente" value="">
                </div>
            </div>

            <!-- Categoria e Tags -->
            <div class="card mb-4 slide-up stagger-3">
                <div class="card-header">
                    <i class="bi bi-tags me-2"></i>
                    Categorizzazione
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-control" name="categoria"
                                value="{{ news.categoria if news and news.categoria else '' }}"
                                placeholder="Es. Aziendale, Prodotti, Eventi"
                                list="categorieList">
                            <datalist id="categorieList">
                                <option value="Aziendale">
                                <option value="Prodotti">
                                <option value="Eventi">
                                <option value="Comunicati">
                                <option value="Tutorial">
                            </datalist>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tags</label>
                            <input type="text" class="form-control" name="tags"
                                value="{{ news.tags if news and news.tags else '' }}"
                                placeholder="tag1, tag2, tag3">
                            <small class="text-muted">Separa i tag con virgole</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pubblicazione -->
            <div class="card mb-4 slide-up stagger-4">
                <div class="card-header">
                    <i class="bi bi-calendar-check me-2"></i>
                    Pubblicazione
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label">Data e Ora Pubblicazione</label>
                            <input type="datetime-local" class="form-control" name="data_pubblicazione"
                                value="{{ news.data_pubblicazione.strftime('%Y-%m-%dT%H:%M') if news and news.data_pubblicazione else '' }}">
                            <small class="text-muted">Lascia vuoto per pubblicare immediatamente</small>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded h-100" style="background: var(--gray-100);">
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-3" type="checkbox" name="pubblicato" id="pubblicato"
                                        {{ 'checked' if news and news.pubblicato else '' }}
                                        style="width: 3.5rem; height: 1.75rem;">
                                    <label class="form-check-label" for="pubblicato">
                                        <strong class="d-block">Pubblicato</strong>
                                        <small class="text-muted">Visibile al pubblico</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="p-3 rounded h-100" style="background: var(--gray-100);">
                                <div class="form-check form-switch d-flex align-items-center">
                                    <input class="form-check-input me-3" type="checkbox" name="in_evidenza" id="in_evidenza"
                                        {{ 'checked' if news and news.in_evidenza else '' }}
                                        style="width: 3.5rem; height: 1.75rem;">
                                    <label class="form-check-label" for="in_evidenza">
                                        <strong class="d-block">In Evidenza</strong>
                                        <small class="text-muted">Mostra in homepage</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pulsanti Azione -->
            <div class="d-flex gap-3 mb-4">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-lg me-1"></i>
                    {{ 'Salva Modifiche' if news else 'Pubblica News' }}
                </button>
                <a href="{{ url_for('lista_news') }}" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-lg me-1"></i>
                    Annulla
                </a>
            </div>
        </form>
    </div>

    <!-- Sidebar Info -->
    <div class="col-lg-4">
        {% if news %}
        <!-- Info News -->
        <div class="card mb-4 slide-up">
            <div class="card-header">
                <i class="bi bi-info-circle me-2"></i>
                Informazioni News
            </div>
            <div class="card-body">
                {% if news.immagine %}
                <img src="{{ url_for('static', filename='uploads/' + news.immagine) }}"
                     alt="{{ news.titolo }}" class="img-fluid rounded mb-3">
                {% endif %}

                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">ID News</span>
                    <span class="fw-semibold">#{{ news.id }}</span>
                </div>
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Creata il</span>
                    <span class="fw-semibold">{{ news.data_creazione.strftime('%d/%m/%Y %H:%M') if news.data_creazione else '-' }}</span>
                </div>
                {% if news.data_modifica %}
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Ultima modifica</span>
                    <span class="fw-semibold">{{ news.data_modifica.strftime('%d/%m/%Y %H:%M') }}</span>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Stato</span>
                    {% if news.pubblicato %}
                    <span class="badge bg-success">Pubblicato</span>
                    {% else %}
                    <span class="badge bg-secondary">Bozza</span>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Visualizzazioni</span>
                    <span class="fw-semibold">
                        <i class="bi bi-eye me-1"></i>{{ news.visualizzazioni }}
                    </span>
                </div>
                {% if news.autore_id %}
                {% set autore = news.get_autore() %}
                {% if autore %}
                <div class="d-flex justify-content-between py-2">
                    <span class="text-muted">Autore</span>
                    <span class="fw-semibold">{{ autore.nome_completo }}</span>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Azioni Rapide -->
        <div class="card slide-up stagger-1">
            <div class="card-header">
                <i class="bi bi-lightning-charge me-2"></i>
                Azioni Rapide
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="bi bi-trash me-2"></i>Elimina News
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <!-- Suggerimenti -->
        <div class="card slide-up">
            <div class="card-header">
                <i class="bi bi-lightbulb me-2"></i>
                Suggerimenti
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="d-flex mb-3">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>Scegli un titolo accattivante e descrittivo</span>
                    </li>
                    <li class="d-flex mb-3">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>L'estratto appare nelle anteprime - rendilo interessante</span>
                    </li>
                    <li class="d-flex mb-3">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>Usa un'immagine di copertina di alta qualita</span>
                    </li>
                    <li class="d-flex mb-3">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>Categorizza correttamente per una migliore organizzazione</span>
                    </li>
                    <li class="d-flex">
                        <i class="bi bi-check-circle-fill text-success me-2 mt-1"></i>
                        <span>Puoi programmare la pubblicazione per una data futura</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Shortcut -->
        <div class="card mt-4 slide-up stagger-1">
            <div class="card-header">
                <i class="bi bi-keyboard me-2"></i>
                Formattazione Testo
            </div>
            <div class="card-body">
                <p class="small text-muted mb-2">Puoi usare HTML nel contenuto:</p>
                <code class="d-block mb-1">&lt;b&gt;grassetto&lt;/b&gt;</code>
                <code class="d-block mb-1">&lt;i&gt;corsivo&lt;/i&gt;</code>
                <code class="d-block mb-1">&lt;a href="..."&gt;link&lt;/a&gt;</code>
                <code class="d-block mb-1">&lt;ul&gt;&lt;li&gt;lista&lt;/li&gt;&lt;/ul&gt;</code>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if news %}
<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    Conferma Eliminazione
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Sei sicuro di voler eliminare la news <strong>{{ news.titolo }}</strong>?</p>
                <p class="text-muted small mt-2 mb-0">Questa azione non puo essere annullata.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form action="{{ url_for('elimina_news', id=news.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Elimina
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Galleria Immagini Modal -->
<div class="modal fade" id="galleriaModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-images me-2"></i>
                    Galleria Immagini
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="btnUsaCopertina">
                            <i class="bi bi-image me-1"></i>Usa come copertina
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="btnInserisciContenuto">
                            <i class="bi bi-file-text me-1"></i>Inserisci nel contenuto
                        </button>
                    </div>
                </div>
                <div id="galleriaLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                    <p class="mt-2 text-muted">Caricamento immagini...</p>
                </div>
                <div id="galleriaEmpty" class="text-center py-5" style="display: none;">
                    <i class="bi bi-images text-muted" style="font-size: 3rem;"></i>
                    <p class="mt-2 text-muted">Nessuna immagine caricata</p>
                </div>
                <div id="galleriaGrid" class="row g-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-genera slug dal titolo
    document.getElementById('titoloInput').addEventListener('input', function() {
        const slugInput = document.getElementById('slugInput');
        if (!slugInput.dataset.customized) {
            const slug = this.value
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            slugInput.value = slug;
        }
    });

    document.getElementById('slugInput').addEventListener('input', function() {
        this.dataset.customized = 'true';
    });

    // Image preview
    document.getElementById('immagineInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        // Resetta immagine esistente se si carica una nuova
        document.getElementById('immagineEsistente').value = '';

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.style.display = 'none';
        }
    });

    // Form validation feedback
    document.getElementById('newsForm').addEventListener('submit', function(e) {
        const btn = this.querySelector('button[type="submit"]');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvataggio...';
        btn.disabled = true;
    });

    // ============ TOOLBAR FORMATTAZIONE ============
    const editor = document.getElementById('contenutoEditor');

    function formatText(type) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const selectedText = editor.value.substring(start, end);
        let before = editor.value.substring(0, start);
        let after = editor.value.substring(end);
        let replacement = '';

        switch(type) {
            case 'bold':
                replacement = `<b>${selectedText || 'testo'}</b>`;
                break;
            case 'italic':
                replacement = `<i>${selectedText || 'testo'}</i>`;
                break;
            case 'underline':
                replacement = `<u>${selectedText || 'testo'}</u>`;
                break;
            case 'strikethrough':
                replacement = `<s>${selectedText || 'testo'}</s>`;
                break;
            case 'h2':
                replacement = `<h2>${selectedText || 'Titolo'}</h2>`;
                break;
            case 'h3':
                replacement = `<h3>${selectedText || 'Sottotitolo'}</h3>`;
                break;
            case 'ul':
                if (selectedText) {
                    const items = selectedText.split('\n').map(item => `    <li>${item}</li>`).join('\n');
                    replacement = `<ul>\n${items}\n</ul>`;
                } else {
                    replacement = `<ul>\n    <li>Elemento 1</li>\n    <li>Elemento 2</li>\n</ul>`;
                }
                break;
            case 'ol':
                if (selectedText) {
                    const items = selectedText.split('\n').map(item => `    <li>${item}</li>`).join('\n');
                    replacement = `<ol>\n${items}\n</ol>`;
                } else {
                    replacement = `<ol>\n    <li>Elemento 1</li>\n    <li>Elemento 2</li>\n</ol>`;
                }
                break;
            case 'link':
                const url = prompt('Inserisci URL:', 'https://');
                if (url) {
                    replacement = `<a href="${url}">${selectedText || 'Clicca qui'}</a>`;
                } else {
                    return;
                }
                break;
            case 'image':
                const imgUrl = prompt('Inserisci URL immagine:', 'https://');
                if (imgUrl) {
                    const alt = selectedText || 'Immagine';
                    replacement = `<img src="${imgUrl}" alt="${alt}" class="img-fluid">`;
                } else {
                    return;
                }
                break;
            case 'quote':
                replacement = `<blockquote class="blockquote">\n    <p>${selectedText || 'Citazione'}</p>\n</blockquote>`;
                break;
            case 'code':
                replacement = `<code>${selectedText || 'codice'}</code>`;
                break;
            case 'hr':
                replacement = `<hr>`;
                break;
        }

        editor.value = before + replacement + after;
        editor.focus();
        editor.selectionStart = start;
        editor.selectionEnd = start + replacement.length;
    }

    // ============ GALLERIA IMMAGINI ============
    let galleriaMode = 'copertina'; // 'copertina' o 'contenuto'
    let immaginiCaricate = [];

    document.getElementById('btnUsaCopertina').addEventListener('click', function() {
        galleriaMode = 'copertina';
        this.classList.add('active');
        document.getElementById('btnInserisciContenuto').classList.remove('active');
    });

    document.getElementById('btnInserisciContenuto').addEventListener('click', function() {
        galleriaMode = 'contenuto';
        this.classList.add('active');
        document.getElementById('btnUsaCopertina').classList.remove('active');
    });

    // Carica immagini quando si apre la galleria
    document.getElementById('galleriaModal').addEventListener('show.bs.modal', function() {
        caricaGalleria();
    });

    function caricaGalleria() {
        const loading = document.getElementById('galleriaLoading');
        const empty = document.getElementById('galleriaEmpty');
        const grid = document.getElementById('galleriaGrid');

        loading.style.display = 'block';
        empty.style.display = 'none';
        grid.style.display = 'none';

        fetch('/api/immagini')
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                immaginiCaricate = data;

                if (data.length === 0) {
                    empty.style.display = 'block';
                } else {
                    grid.innerHTML = '';
                    data.forEach(img => {
                        const col = document.createElement('div');
                        col.className = 'col-6 col-md-4 col-lg-3';
                        col.innerHTML = `
                            <div class="card h-100 galleria-item" style="cursor: pointer;" data-filename="${img.filename}" data-url="${img.url}">
                                <img src="${img.url}" class="card-img-top" alt="${img.filename}" style="height: 120px; object-fit: cover;">
                                <div class="card-body p-2">
                                    <small class="text-muted text-truncate d-block">${img.filename}</small>
                                    <small class="text-muted">${formatFileSize(img.size)}</small>
                                </div>
                            </div>
                        `;
                        grid.appendChild(col);
                    });
                    grid.style.display = 'flex';

                    // Aggiungi event listeners
                    document.querySelectorAll('.galleria-item').forEach(item => {
                        item.addEventListener('click', function() {
                            selezionaImmagine(this.dataset.filename, this.dataset.url);
                        });
                    });
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                empty.innerHTML = '<i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i><p class="mt-2 text-danger">Errore nel caricamento</p>';
                empty.style.display = 'block';
            });
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function selezionaImmagine(filename, url) {
        if (galleriaMode === 'copertina') {
            // Imposta come immagine di copertina
            document.getElementById('immagineEsistente').value = filename;
            document.getElementById('immagineInput').value = '';

            // Mostra preview
            const previewContainer = document.getElementById('previewContainer');
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.src = url;
            previewContainer.style.display = 'block';
            previewContainer.querySelector('label').textContent = 'Immagine selezionata dalla galleria:';

            // Chiudi modal
            bootstrap.Modal.getInstance(document.getElementById('galleriaModal')).hide();

        } else {
            // Inserisci nel contenuto
            const imgTag = `<img src="${url}" alt="Immagine" class="img-fluid my-2">`;
            const start = editor.selectionStart;
            const before = editor.value.substring(0, start);
            const after = editor.value.substring(start);
            editor.value = before + imgTag + after;

            // Chiudi modal
            bootstrap.Modal.getInstance(document.getElementById('galleriaModal')).hide();

            // Focus sull'editor
            editor.focus();
        }
    }
</script>
{% endblock %}
