{% extends "base.html" %}
{% from "_macros.html" import render_field %}
{% block title %}{{ titolo }}{% endblock %}
{% block content %}
<h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem;">{{ titolo }}</h1>
<div class="card">
    <form method="POST">
        {{ form.hidden_tag() }}
        {{ render_field(form.nome) }}
        {{ render_field(form.descrizione) }}

        <h3 style="font-size: 1.25rem; margin: 1.5rem 0 1rem;">Permessi</h3>
        <p style="color: #64748b; margin-bottom: 1rem;">Seleziona i permessi da assegnare a questo ruolo:</p>

        {% for modulo, permessi in permessi_per_modulo.items() %}
        <div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px;">
            <h4 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; text-transform: capitalize;">
                <i class="fas fa-folder" style="color: #dc2626; margin-right: 0.5rem;"></i>
                {{ modulo }}
            </h4>
            <div class="grid grid-2">
                {% for permesso in permessi %}
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="permessi" value="{{ permesso.id }}" id="perm_{{ permesso.id }}"
                           {% if permessi_selezionati and permesso.id in permessi_selezionati %}checked{% endif %}
                           style="width: 18px; height: 18px; cursor: pointer;">
                    <label for="perm_{{ permesso.id }}" style="cursor: pointer; margin: 0;">
                        <strong>{{ permesso.nome }}</strong>
                        {% if permesso.descrizione %}
                        <br><small style="color: #64748b;">{{ permesso.descrizione }}</small>
                        {% endif %}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <div class="d-flex gap-2" style="margin-top: 1.5rem;">
            <button type="submit" class="btn btn-info"><i class="fas fa-save"></i> Salva</button>
            <a href="{{ url_for('ruoli.lista') }}" class="btn btn-secondary">Annulla</a>
        </div>
    </form>
</div>

<script>
// Seleziona/Deseleziona tutti i permessi di un modulo
document.querySelectorAll('h4').forEach(header => {
    header.style.cursor = 'pointer';
    header.addEventListener('click', function() {
        const container = this.parentElement;
        const checkboxes = container.querySelectorAll('input[type="checkbox"]');
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        checkboxes.forEach(cb => cb.checked = !allChecked);
    });
});
</script>
{% endblock %}
